<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Reports - MacBookDepot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .nav {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .nav a {
            color: #667eea;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 600;
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .report-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .report-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            width: 100%;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn.government {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .date-filter {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .date-filter input {
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
        }

        .report-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            max-height: 500px;
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Business Reports</h1>
            <p>Government compliance and business analytics</p>
        </div>

       <div class="nav">
    <a href="/">Dashboard</a>
    <a href="/excel">Excel Upload</a>
    <a href="/sales">Sales Entry</a>
    <a href="/costs">Cost Management</a>
    <a href="/reports">Reports</a>
</div>

        <div class="section">
            <h2>Date Range Filter</h2>
            <div class="date-filter">
                <label>From:</label>
                <input type="date" id="startDate">
                <label>To:</label>
                <input type="date" id="endDate">
                <button class="btn" id="applyDateFilter">Apply Filter</button>
            </div>
        </div>

        <div class="section">
            <h2>Report Types</h2>
            <div class="report-buttons">
                <div class="report-card">
                    <h3>Government Reports</h3>
                    <p>For tax compliance and official documentation</p>
                    <button class="btn government" id="interacReportBtn">Interac Sales Report</button>
                    <button class="btn government" id="purchaseReportBtn">Purchase Documentation</button>
                </div>

                <div class="report-card">
                    <h3>Business Analytics</h3>
                    <p>Internal tracking and profit analysis</p>
                    <button class="btn" id="fullSalesReportBtn">Complete Sales Report</button>
                    <button class="btn" id="inventoryReportBtn">Inventory Overview</button>
                </div>

                <div class="report-card">
                    <h3>Financial Summary</h3>
                    <p>Profit margins and cost analysis</p>
                    <button class="btn" id="profitReportBtn">Profit Analysis</button>
                    <button class="btn" id="costReportBtn">Cost Breakdown</button>
                </div>
            </div>
        </div>

        <div class="report-content" id="reportContent">
            <div id="reportHeader"></div>
            <div id="reportStats"></div>
            <div id="reportTable"></div>
            <button class="btn" id="exportBtn" style="display: none;">Export to CSV</button>
        </div>
    </div>

    <script>
        let currentReportData = null;
        let dateFilter = { start: null, end: null };

        // Set default dates to current month
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

        document.getElementById('startDate').value = firstDay.toISOString().split('T')[0];
        document.getElementById('endDate').value = lastDay.toISOString().split('T')[0];

        // Date filter
        document.getElementById('applyDateFilter').addEventListener('click', () => {
            dateFilter.start = document.getElementById('startDate').value;
            dateFilter.end = document.getElementById('endDate').value;
            console.log('Date filter applied:', dateFilter);
        });

        // Report buttons
        document.getElementById('interacReportBtn').addEventListener('click', () => generateReport('interac-sales'));
        document.getElementById('purchaseReportBtn').addEventListener('click', () => generateReport('purchases'));
        document.getElementById('fullSalesReportBtn').addEventListener('click', () => generateReport('all-sales'));
        document.getElementById('inventoryReportBtn').addEventListener('click', () => generateReport('inventory'));
        document.getElementById('profitReportBtn').addEventListener('click', () => generateReport('profit'));
        document.getElementById('costReportBtn').addEventListener('click', () => generateReport('costs'));

        async function generateReport(reportType) {
            try {
                const params = new URLSearchParams({
                    type: reportType,
                    startDate: dateFilter.start || '',
                    endDate: dateFilter.end || ''
                });

                const response = await fetch(`/api/reports?${params}`);
                const data = await response.json();

                if (response.ok) {
                    currentReportData = data;
                    displayReport(reportType, data);
                } else {
                    alert('Error generating report: ' + data.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function displayReport(reportType, data) {
            const reportContent = document.getElementById('reportContent');
            const reportHeader = document.getElementById('reportHeader');
            const reportStats = document.getElementById('reportStats');
            const reportTable = document.getElementById('reportTable');
            const exportBtn = document.getElementById('exportBtn');

            // Set report header
            const titles = {
                'interac-sales': 'Interac Sales Report (Government Compliance)',
                'purchases': 'Purchase Documentation',
                'all-sales': 'Complete Sales Report',
                'inventory': 'Inventory Overview',
                'profit': 'Profit Analysis',
                'costs': 'Cost Breakdown'
            };

            reportHeader.innerHTML = `<h3>${titles[reportType]}</h3>`;

            // Display stats if available
            if (data.stats) {
                let statsHtml = '<div class="stats-grid">';
                Object.entries(data.stats).forEach(([key, value]) => {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    statsHtml += `
                        <div class="stat-card">
                            <div class="stat-number">${typeof value === 'number' && key.includes('amount') ? '$' + value.toFixed(2) : value}</div>
                            <div class="stat-label">${label}</div>
                        </div>
                    `;
                });
                statsHtml += '</div>';
                reportStats.innerHTML = statsHtml;
            } else {
                reportStats.innerHTML = '';
            }

            // Display table
            if (data.data && data.data.length > 0) {
                reportTable.innerHTML = createTable(data.data, reportType);
                exportBtn.style.display = 'inline-block';
            } else {
                reportTable.innerHTML = '<p>No data found for the selected criteria.</p>';
                exportBtn.style.display = 'none';
            }

            reportContent.style.display = 'block';
        }

        function createTable(data, reportType) {
            if (!data.length) return '<p>No data available</p>';

            const headers = Object.keys(data[0]);
            let html = '<table><thead><tr>';
            
            headers.forEach(header => {
                const displayName = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                html += `<th>${displayName}</th>`;
            });
            html += '</tr></thead><tbody>';

            data.forEach(row => {
                html += '<tr>';
                headers.forEach(header => {
                    let value = row[header];
                    if (header.includes('date') && value) {
                        value = new Date(value).toLocaleDateString();
                    } else if (header.includes('amount') || header.includes('price') || header.includes('cost')) {
                        value = '$' + parseFloat(value || 0).toFixed(2);
                    }
                    html += `<td>${value || ''}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        // Export functionality
        document.getElementById('exportBtn').addEventListener('click', () => {
            if (!currentReportData || !currentReportData.data) return;

            const csv = convertToCSV(currentReportData.data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        });

        function convertToCSV(data) {
            if (!data.length) return '';

            const headers = Object.keys(data[0]);
            const csvRows = [];

            csvRows.push(headers.join(','));

            data.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header] || '';
                    if (typeof value === 'string' && value.includes(',')) {
                        value = `"${value}"`;
                    }
                    return value;
                });
                csvRows.push(values.join(','));
            });

            return csvRows.join('\n');
        }
    </script>
</body>
</html>